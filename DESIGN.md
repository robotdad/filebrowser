# Filebrowser Design

## Goal

A web-based remote file browser for headless Linux machines, accessible over Tailscale.

## Background

Three personal headless boxes (2 DGX Spark devices, 1 Raspberry Pi 4 with 8GB RAM) need a lightweight way to browse, preview, and manage files from any device on the tailnet. Each box has a single primary user with an existing Linux account. The solution must be minimal in resource usage, require no build toolchain, and leverage existing infrastructure (Tailscale, PAM, systemd).

## Approach

**Approach B: FastAPI + Preact/HTM** was chosen over:

- **Vanilla JS** - lacks a component model, making the two-panel UI unwieldy to maintain
- **Full React** - unnecessary build toolchain for a lightweight file browser

The selected stack:

| Layer | Technology | Rationale |
|---|---|---|
| Backend | Python (FastAPI) + uvicorn | Async, minimal, excellent DX |
| Frontend | Preact (3KB) + HTM (tagged templates) | No JSX, no build step |
| Reverse Proxy/SSL | Caddy with Tailscale certs | Clean HTTPS termination, cert reload |
| Service Manager | systemd | Standard, reliable, already present |

## Architecture

```
Browser (any device on tailnet)
   │
   │  HTTPS (Tailscale cert)
   ▼
┌──────────┐
│  Caddy   │  :443 → localhost:8000
│          │  :80  → redirect to :443
└────┬─────┘
     │  HTTP
     ▼
┌──────────────┐
│   uvicorn    │
│   FastAPI    │  Serves API + static files
│              │  Runs as user (not root)
└──────────────┘
     │
     ▼
  Linux filesystem (scoped to user's home)
```

Caddy handles HTTPS termination using certs generated by `tailscale cert`. FastAPI serves both the REST API and static frontend assets. The service runs as the logged-in user so Linux file permissions are naturally enforced.

## Components

### Backend

#### API Design

All endpoints live under `/api/`. Every `/api/files/*` endpoint requires a valid session cookie.

**Auth:**

| Method | Endpoint | Description |
|---|---|---|
| POST | `/api/auth/login` | PAM authenticate, create session cookie |
| POST | `/api/auth/logout` | Destroy session |
| GET | `/api/auth/me` | Current user info |

**Files:**

| Method | Endpoint | Description |
|---|---|---|
| GET | `/api/files?path=` | List directory (name, type, size, modified) |
| GET | `/api/files/info?path=` | Single file metadata |
| GET | `/api/files/content?path=` | Text content or binary stream |
| GET | `/api/files/download?path=` | Force download (Content-Disposition) |
| POST | `/api/files/upload?path=` | Upload file(s) to directory |
| POST | `/api/files/mkdir?path=` | Create directory |
| PUT | `/api/files/rename` | Rename or move (old_path, new_path) |
| DELETE | `/api/files?path=` | Delete file or directory |

#### Auth Model

- PAM validates Linux credentials via `python-pam`
- On success, FastAPI creates a signed session cookie (httponly, secure, samesite=strict)
- Session expires after 24 hours (configurable)
- Every `/api/files/*` endpoint requires a valid session

#### Security

- All paths resolved and validated to stay within the user's home directory (no path traversal)
- Service runs as the logged-in user (not root) so file permissions are naturally enforced
- Personal boxes with one main user each

#### Python Dependencies

| Package | Purpose |
|---|---|
| fastapi + uvicorn[standard] | Server |
| python-pam | PAM authentication |
| python-multipart | File upload handling |
| itsdangerous | Signed session cookies |

### Frontend

#### Stack

- **Preact + HTM** (~5KB total) - component model with no build step
- **highlight.js** (~30KB) - code syntax highlighting
- **marked.js** (~12KB) - markdown rendering
- All loaded via CDN

#### Layout

Two-panel, responsive:

```
┌─────────────────────────────────────────────────┐
│  Header: breadcrumb path  |  user  |  logout    │
├───────────────┬─────────────────────────────────┤
│               │                                 │
│  File Tree    │      Preview Pane               │
│  (sidebar)    │                                 │
│               │  Text: line numbers + content   │
│  folders/     │  Code: syntax highlighted       │
│    files      │  Markdown: rendered HTML         │
│               │  Images: inline preview          │
│               │  Audio: <audio> player           │
│               │  Video: <video> player           │
│               │  Other: file info + download     │
│               │                                 │
├───────────────┴─────────────────────────────────┤
│  Actions: upload | new folder | rename | delete │
└─────────────────────────────────────────────────┘
```

#### Mobile Behavior

Below ~768px the sidebar collapses into a slide-out drawer. Tapping a file in the drawer closes it and shows the preview. A hamburger icon reopens the drawer.

#### Components

| Component | Responsibility |
|---|---|
| App | Top-level auth routing (login vs main view) |
| LoginForm | Username/password, calls PAM auth endpoint |
| FileTree | Recursive folder/file tree, lazy-loads subdirectories on expand |
| PreviewPane | Detects file type, renders appropriate viewer |
| Breadcrumb | Clickable path segments for navigation |
| ActionBar | Context-sensitive actions (upload, mkdir, rename, delete) |
| UploadModal | Drag-and-drop + file picker |

#### File Type Detection

Client-side, by extension:

| Category | Extensions | Renderer |
|---|---|---|
| Text | .txt, .log, .csv, .json, .xml, .yaml, .toml, .env, .conf | Line numbers + content |
| Code | .py, .js, .ts, .go, .rs, .c, .cpp, .java, .sh, .sql | highlight.js |
| Markdown | .md | marked.js |
| Image | .png, .jpg, .jpeg, .gif, .webp, .svg, .bmp | Inline `<img>` |
| Audio | .mp3, .wav, .ogg, .flac, .aac, .m4a | `<audio>` player |
| Video | .mp4, .webm, .mkv, .mov, .avi | `<video>` player |
| PDF | .pdf | Browser viewer via iframe |
| Other | * | Metadata display + download button |

#### Light/Dark Mode

CSS custom properties with `@media (prefers-color-scheme: dark)`. All colors defined as variables, one set for light, one for dark. Follows system preference with no manual toggle.

## Data Flow

**Authentication:**
1. User submits credentials via LoginForm
2. POST `/api/auth/login` validates against PAM
3. On success, server sets a signed httponly cookie
4. All subsequent API requests include the cookie automatically
5. 401 responses trigger redirect to login

**File browsing:**
1. App loads, GET `/api/files?path=/` fetches root listing
2. User clicks folder in FileTree, GET `/api/files?path=/subfolder` lazy-loads contents
3. User clicks file, GET `/api/files/content?path=/file.txt` streams content to PreviewPane
4. PreviewPane detects type by extension and selects the appropriate renderer

**File operations:**
1. Upload: POST multipart to `/api/files/upload?path=<dir>`
2. Create folder: POST to `/api/files/mkdir?path=<new_dir>`
3. Rename/move: PUT to `/api/files/rename` with old_path and new_path
4. Delete: DELETE to `/api/files?path=<target>`
5. All mutations refresh the FileTree listing for the affected directory

## Error Handling

### Backend

All errors return consistent JSON:

```json
{"error": "description", "code": "ERROR_TYPE"}
```

| Scenario | HTTP Status | Code |
|---|---|---|
| Path traversal attempt | 403 | PATH_FORBIDDEN |
| File not found | 404 | NOT_FOUND |
| Permission denied (OS-level) | 403 | PERMISSION_DENIED |
| Upload too large | 413 | FILE_TOO_LARGE |
| Invalid session | 401 | UNAUTHORIZED |
| PAM auth failure | 401 | AUTH_FAILED |
| Disk full on upload | 507 | INSUFFICIENT_STORAGE |

Upload size limit is configurable (default 1GB).

### Frontend

- Toast-style notifications at the top of the preview pane for user-facing errors
- 401 responses automatically redirect to the login screen

## Infrastructure & Deployment

### SSL via Tailscale

- Each box has a Tailscale FQDN like `hostname.tailnet-name.ts.net`
- `tailscale cert` generates Let's Encrypt certs automatically
- Users navigate by short hostname via MagicDNS (e.g., `https://dgx-spark-1/`)
- The install script auto-detects the full FQDN via `tailscale status --json`

### Caddy as Reverse Proxy

- HTTPS termination using Tailscale-generated certs
- HTTP (80) to HTTPS (443) redirect
- Reverse proxy to uvicorn on `localhost:8000`

### systemd Services

- **filebrowser.service** - Python app via uvicorn, runs as user, `After=network.target tailscaled.service`, `Restart=always`
- **Caddy** ships with its own systemd unit
- Both enabled at boot via `systemctl enable`

### Cert Renewal

- Tailscale certs are valid for 90 days
- A systemd timer runs `tailscale cert` weekly
- Caddy detects cert file changes and reloads automatically

### Deployment Flow

1. Clone the repo
2. Run `install.sh` which: creates a venv, pip installs dependencies, installs Caddy, generates the Tailscale cert, writes systemd units, enables and starts everything
3. Browse to `https://your-box/` from any device on the tailnet

### Pi 4 Considerations

Uvicorn + FastAPI idles at ~20MB RAM. Caddy idles at ~10MB. No concern for 8GB Pi.

## Project Structure

```
filebrowser/
├── pyproject.toml
├── filebrowser/
│   ├── __init__.py
│   ├── main.py              # FastAPI app, mounts static, CORS, lifespan
│   ├── auth.py              # PAM auth + session management
│   ├── config.py            # Settings (home dir, session timeout, etc.)
│   ├── routes/
│   │   ├── __init__.py
│   │   ├── auth.py          # /api/auth/* endpoints
│   │   └── files.py         # /api/files/* endpoints
│   ├── services/
│   │   ├── __init__.py
│   │   └── filesystem.py    # Path validation, file ops, type detection
│   └── static/
│       ├── index.html
│       ├── css/
│       │   └── styles.css
│       └── js/
│           ├── app.js
│           ├── api.js
│           └── components/
│               ├── login.js
│               ├── layout.js
│               ├── tree.js
│               ├── preview.js
│               ├── breadcrumb.js
│               ├── actions.js
│               └── upload.js
├── deploy/
│   ├── install.sh
│   ├── filebrowser.service
│   └── Caddyfile.template
└── tests/
    ├── test_auth.py
    ├── test_files.py
    └── test_filesystem.py
```

## Testing Strategy

| Test File | Scope | Priority |
|---|---|---|
| test_filesystem.py | Path validation (traversal prevention), file type detection, directory listing. Pure functions, security-critical. | Highest |
| test_auth.py | PAM integration mocked at boundary, session creation/validation/expiry. | High |
| test_files.py | API route integration tests via FastAPI TestClient. Upload, download, rename, delete, mkdir against a temp directory. | Medium |

Priority order: path validation and auth (security boundary) first, then file operations, then type detection.

## Decisions Log

| Decision | Chosen | Over | Rationale |
|---|---|---|---|
| Stack | FastAPI + Preact/HTM | Vanilla JS, full React | Component model without build toolchain |
| Reverse proxy | Caddy | Bare uvicorn | Clean HTTPS termination, cert reload |
| Auth | PAM | Custom users | Leverages existing Linux accounts |
| Service user | Run as user | Run as root | Single-user personal boxes |
| Theme | System preference only | Manual toggle | Simpler, respects user OS setting |
| Frontend libs | CDN | Bundled | No build step, trivial on Pi 4 |

## Open Questions

None at this time. All design decisions have been validated.
